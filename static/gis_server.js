var flag = 1;
var myStyle = {
    "color": "#ff7800",
    "weight": 5,
    "opacity": 0.65
};


var CorPol = [[[58.05472, 56.21368],[58.05476, 56.21471], [58.05186, 56.21373], [58.05238, 56.21282], [58.05472, 56.21368]],
[[58.05459, 56.2151],[58.05197, 56.21427], [58.05187, 56.21451], [58.05187, 56.21732], [58.05231, 56.21732], [58.05253, 56.21764], [58.05505, 56.21734], [58.05488, 56.2162], [58.05463, 56.21615], [58.05459, 56.2151]],
[[58.05253, 56.21764], [58.05505, 56.21734], [58.05561, 56.2177], [58.0554, 56.21995], [58.05491, 56.21981], [58.05262, 56.21858], [58.05253, 56.21764]],
[[58.05539, 56.21996], [58.05488, 56.21981], [58.05262, 56.21858], [58.05238, 56.2186], [58.05238, 56.21839], [58.05183, 56.21851], [58.05182, 56.22251], [58.05517, 56.22235], [58.05539, 56.21996]],
[[58.05481, 56.22238], [58.05521, 56.22233], [58.05491, 56.22573], [58.05479, 56.22571], [58.05479, 56.22467], [58.05363, 56.22464], [58.05363, 56.2242], [58.05481, 56.22418], [58.0548, 56.22241], [58.05481, 56.22238]],
[[58.05363, 56.2242], [58.05481, 56.22418], [58.0548, 56.22241], [58.05362, 56.22244], [58.05363, 56.2242]],
[[58.05182, 56.22253], [58.05362, 56.22243], [58.05356, 56.22585], [58.05345, 56.22613], [58.05266, 56.22613], [58.05224, 56.22642], [58.05183, 56.22529], [58.05182, 56.22253]],
];

var statesData = {"type":"FeatureCollection","features":[
{"type":"Feature","id":"01","properties":{"name":"pol1","density":1},"geometry":{"type":"Polygon","coordinates":[[ [56.21368, 58.05472],[56.21471, 58.05476], [56.21373, 58.05186], [56.21282, 58.05238], [56.21368, 58.05472] ]]}},
{"type":"Feature","id":"02","properties":{"name":"pol2","density":2},"geometry":{"type":"Polygon","coordinates":[[ [56.2151, 58.05459],[56.21427, 58.05197], [56.21451, 58.05187], [56.21732, 58.05187], [56.21732, 58.05231], [56.21764, 58.05253], [56.21734, 58.05505], [56.2162, 58.05488], [56.21615, 58.05463], [56.2151, 58.05459] ]]}},
{"type":"Feature","id":"03","properties":{"name":"pol3","density":3},"geometry":{"type":"Polygon","coordinates":[[ [56.21764, 58.05253], [56.21734, 58.05505], [56.2177, 58.05561], [56.21995, 58.0554], [56.21981, 58.05491], [56.21858, 58.05262], [56.21764, 58.05253]]]}},
{"type":"Feature","id":"04","properties":{"name":"pol4","density":1},"geometry":{"type":"Polygon","coordinates":[[ [56.21996, 58.05539], [56.21981, 58.05488], [56.21858, 58.05262], [56.2186, 58.05238], [56.21839, 58.05238], [56.21851, 58.05183], [56.22251, 58.05182], [56.22235, 58.05517], [56.21996, 58.05539]]]}},
{"type":"Feature","id":"05","properties":{"name":"pol5","density":2},"geometry":{"type":"Polygon","coordinates":[[ [56.22238, 58.05481], [56.22233, 58.05521], [56.22573, 58.05491], [56.22571, 58.05479], [56.22467, 58.05479], [56.22464, 58.05363], [56.2242, 58.05363], [56.22418, 58.05481], [56.22241, 58.0548], [56.22238, 58.05481]]]}},
{"type":"Feature","id":"06","properties":{"name":"pol6","density":3},"geometry":{"type":"Polygon","coordinates":[[ [56.2242, 58.05363], [56.22418, 58.05481], [56.22241, 58.0548], [56.22244, 58.05362], [56.2242, 58.05363]]]}},
{"type":"Feature","id":"07","properties":{"name":"pol7","density":3},"geometry":{"type":"Polygon","coordinates":[[ [56.22253, 58.05182], [56.22243, 58.05362], [56.22585, 58.05356], [56.22613, 58.05345], [56.22613, 58.05266], [56.22642, 58.05224], [56.22529, 58.05183], [56.22253, 58.05182]]]}},
]};

var TileLayer = {
    //"TileLayer": L.tileLayer('TileGenPerm/{z}/{x}/{y}.png', {maxZoom: 17, minZoom: 13})
    "TileLayer": L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
			maxZoom: 17,
            minZoom: 13,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		})
};
var MrpLocation = [58.05591, 56.21541];
var map = L.map('map').setView(MrpLocation, 17);

// control that shows state info on hover
		var info = L.control({position: 'topright'});

		info.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'info');
			this.update();
			return this._div;
		};

		info.update = function (props) {
			this._div.innerHTML = '<h4>Имя полигона и проходимость</h4>' +  (props ?
				'<b>' + 'Имя полигона:' + '</b>' + props.name + '<br />' + '<b>'+'Проходимость: '+ '</b>'+ props.density
				: 'Наведите указатель на полигон');
		};

		info.addTo(map);
// get color depending on density value
function getColor(d) {
    return d == 3 ? 'green' :
           d == 2  ? 'yellow' :
           d == 1  ? 'red' :
                      '#FFEDA0';
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties.density),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
    };
}
//HighLighting
function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
    });

    if (!L.Browser.ie && !L.Browser.opera) {
        layer.bringToFront();
    }
    info.update(layer.feature.properties);
}
var geojson = L.geoJson(statesData, {style: style, onEachFeature: onEachFeature});
function resetHighlight(e) {
    geojson.resetStyle(e.target);
    info.update();
}
function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
}
function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
    });
}

/*
var states = {
    "type":"Feature",
   "properties": {"party": "dd"},
   "geometry": {
       "type": "Polygon",
       "coordinates": [[
           [58.05472, 56.21368], [58.05476, 56.21471], [58.05186, 56.21373], [58.05238, 56.21282],
           [58.05472, 56.21368]
       ]]
   }
};
console.log(statesData);*/
//var PolygonsLayer = new L.layerGroup(L.geoJson(statesData))
var overlays  = {
    "Polygons": geojson
};

map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');

var legend = L.control({position: 'topright'});
legend.onAdd = function (map) {

			var div = L.DomUtil.create('div', 'info legend'),
				grades = [1,2,3],
				labels = [],
				from;

			for (var i = 0; i < grades.length; i++) {
				from = grades[i];


				labels.push(
					'<i style="background:' + getColor(from) + '"></i> ' +
					from);
			}

			div.innerHTML = labels.join('<br>');
			return div;
		};

		legend.addTo(map);

//L.control.layers(TileLayer).addTo(map);
/*
var TileLayer = L.tileLayer('TileGenPerm/{z}/{x}/{y}.png', {
    maxZoom: 17,
    minZoom: 13
}).addTo(map);
*/
//L.geoJson(statesData).addTo(map);
L.control.layers(TileLayer, overlays).addTo(map);



var line_way = L.polyline([
    [3.05569, 56.21787],
    [3.055, 56.22627]],
    {
        color: "#ff7800",
        weight: 5,
        opacity: 0.65
    }
    ).addTo(map);

var custom_way = L.polyline([
    ],
    {
        color: "red",
        weight: 5,
        opacity: 0.65
    }
    ).addTo(map);

    //L.geoJson(myLines, {
                    //	style: myStyle
                    //}).addTo(map);

var popup = L.popup();
var marker = L.marker(MrpLocation).addTo(map);
get_loc();

L.easyButton( '<span class="star">&neArr;</span>', function(btn, map)
{
    url = "/GIS/send/way";
    xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.send(JSON.stringify(custom_way.toGeoJSON()));

    //xhr.send(custom_way.toGeoJSON());
    xhr.onreadystatechange = function()
    {
        var loading = document.getElementById ( "wait" );
        var msg = document.getElementById ( "msg" );
        if ( xhr.readyState <= 3 )
            loading.style.visibility = "visible";
            window.setTimeout(function(){ loading.style.visibility = "hidden"; }, 3000);
            msg.style.visibility = "visible";
            window.setTimeout(function(){ msg.style.visibility = "hidden"; }, 3000);
            console.log('visible')
        if (xhr.readyState == 4)
        {
            if (xmlhttp.status == 200)
            {
                xhr.onloadend = function ()
                {
                    // done
                };
                document.getElementById("msg").innerHTML = xhr.responseText;
                loading.style.visibility = "hidden";
                //window.setTimeout(function(){ loading.style.visibility = "hidden"; }, 3000);
                window.setTimeout(function(){ msg.style.visibility = "hidden"; }, 3000);

                line_way = line_way.setLatLngs(custom_way.getLatLngs());
                custom_way = custom_way.setLatLngs([]);
                flag = 1;

            }
            else
            {
                //
            }
        }
    }
}).addTo(map);//building way button

L.easyButton( '<span class="star">&xopf;</span>', function(btn, map){
  //new L.latLng(myLines.geometry.coordinates[index][1], myLines.geometry.coordinates[index][0]);
  custom_way = custom_way.setLatLngs([]);
  flag = 1;
}).addTo(map);

/*var CorPol = [[[58.05472, 56.21368],[58.05476, 56.21471], [58.05186, 56.21373], [58.05238, 56.21282], [58.05472, 56.21368]],
[[58.05459, 56.2151],[58.05197, 56.21427], [58.05187, 56.21451], [58.05187, 56.21732], [58.05231, 56.21732], [58.05253, 56.21764], [58.05505, 56.21734], [58.05488, 56.2162], [58.05463, 56.21615], [58.05459, 56.2151]],
[[58.05253, 56.21764], [58.05505, 56.21734], [58.05561, 56.2177], [58.0554, 56.21995], [58.05491, 56.21981], [58.05262, 56.21858], [58.05253, 56.21764]],
[[58.05539, 56.21996], [58.05488, 56.21981], [58.05262, 56.21858], [58.05238, 56.2186], [58.05238, 56.21839], [58.05183, 56.21851], [58.05182, 56.22251], [58.05517, 56.22235], [58.05539, 56.21996]],
[[58.05481, 56.22238], [58.05521, 56.22233], [58.05491, 56.22573], [58.05479, 56.22571], [58.05479, 56.22467], [58.05363, 56.22464], [58.05363, 56.2242], [58.05481, 56.22418], [58.0548, 56.22241], [58.05481, 56.22238]],
[[58.05363, 56.2242], [58.05481, 56.22418], [58.0548, 56.22241], 58.05362, 56.22244, [58.05363, 56.2242], [58.05363, 56.2242]]
];*/


var CorPol = [[[58.056909999999995, 56.21541], [58.05641, 56.21367794674363], [58.055409999999995, 56.21367794674363], [58.05491, 56.21541], [58.055409999999995, 56.21714205325637], [58.05641, 56.21714205325637], [58.056909999999995, 56.21541]]
,
[[58.056909999999995, 56.218874101615135], [58.05641, 56.21714204835877], [58.055409999999995, 56.21714204835877], [58.05491, 56.218874101615135], [58.055409999999995, 56.220606154871504], [58.05641, 56.220606154871504], [58.056909999999995, 56.218874101615135]]
,
[[58.056909999999995, 56.22233820323027], [58.05641, 56.220606149973904], [58.055409999999995, 56.220606149973904], [58.05491, 56.22233820323027], [58.055409999999995, 56.22407025648664], [58.05641, 56.22407025648664], [58.056909999999995, 56.22233820323027]]
,
[[58.056909999999995, 56.22580230484541], [58.05641, 56.22407025158904], [58.055409999999995, 56.22407025158904], [58.05491, 56.22580230484541], [58.055409999999995, 56.22753435810178], [58.05641, 56.22753435810178], [58.056909999999995, 56.22580230484541]]
,
[[58.056909999999995, 56.229266406460546], [58.05641, 56.22753435320418], [58.055409999999995, 56.22753435320418], [58.05491, 56.229266406460546], [58.055409999999995, 56.230998459716915], [58.05641, 56.230998459716915], [58.056909999999995, 56.229266406460546]]
,
[[58.056909999999995, 56.23273050807568], [58.05641, 56.230998454819314], [58.055409999999995, 56.230998454819314], [58.05491, 56.23273050807568], [58.055409999999995, 56.23446256133205], [58.05641, 56.23446256133205], [58.056909999999995, 56.23273050807568]]
,
[[58.056909999999995, 56.23619460969082], [58.05641, 56.23446255643445], [58.055409999999995, 56.23446255643445], [58.05491, 56.23619460969082], [58.055409999999995, 56.23792666294719], [58.05641, 56.23792666294719], [58.056909999999995, 56.23619460969082]]
,
[[58.056909999999995, 56.23965871130596], [58.05641, 56.23792665804959], [58.055409999999995, 56.23792665804959], [58.05491, 56.23965871130596], [58.055409999999995, 56.241390764562325], [58.05641, 56.241390764562325], [58.056909999999995, 56.23965871130596]]
,
[[58.056909999999995, 56.243122812921094], [58.05641, 56.241390759664725], [58.055409999999995, 56.241390759664725], [58.05491, 56.243122812921094], [58.055409999999995, 56.24485486617746], [58.05641, 56.24485486617746], [58.056909999999995, 56.243122812921094]]
,
[[58.056909999999995, 56.24658691453623], [58.05641, 56.24485486127986], [58.055409999999995, 56.24485486127986], [58.05491, 56.24658691453623], [58.055409999999995, 56.2483189677926], [58.05641, 56.2483189677926], [58.056909999999995, 56.24658691453623]]
,
[[58.055409999999995, 56.21367794919243], [58.05491, 56.21194589593606], [58.053909999999995, 56.21194589593606], [58.05341, 56.21367794919243], [58.053909999999995, 56.2154100024488], [58.05491, 56.2154100024488], [58.055409999999995, 56.21367794919243]]
,
[[58.055409999999995, 56.21714205080757], [58.05491, 56.2154099975512], [58.053909999999995, 56.2154099975512], [58.05341, 56.21714205080757], [58.053909999999995, 56.218874104063936], [58.05491, 56.218874104063936], [58.055409999999995, 56.21714205080757]]
,
[[58.055409999999995, 56.220606152422704], [58.05491, 56.218874099166335], [58.053909999999995, 56.218874099166335], [58.05341, 56.220606152422704], [58.053909999999995, 56.22233820567907], [58.05491, 56.22233820567907], [58.055409999999995, 56.220606152422704]]
,
[[58.055409999999995, 56.22407025403784], [58.05491, 56.22233820078147], [58.053909999999995, 56.22233820078147], [58.05341, 56.22407025403784], [58.053909999999995, 56.22580230729421], [58.05491, 56.22580230729421], [58.055409999999995, 56.22407025403784]]
,
[[58.055409999999995, 56.22753435565298], [58.05491, 56.22580230239661], [58.053909999999995, 56.22580230239661], [58.05341, 56.22753435565298], [58.053909999999995, 56.229266408909346], [58.05491, 56.229266408909346], [58.055409999999995, 56.22753435565298]]
,
[[58.055409999999995, 56.230998457268115], [58.05491, 56.229266404011746], [58.053909999999995, 56.229266404011746], [58.05341, 56.230998457268115], [58.053909999999995, 56.23273051052448], [58.05491, 56.23273051052448], [58.055409999999995, 56.230998457268115]]
,
[[58.055409999999995, 56.23446255888325], [58.05491, 56.23273050562688], [58.053909999999995, 56.23273050562688], [58.05341, 56.23446255888325], [58.053909999999995, 56.23619461213962], [58.05491, 56.23619461213962], [58.055409999999995, 56.23446255888325]]
,
[[58.055409999999995, 56.23792666049839], [58.05491, 56.23619460724202], [58.053909999999995, 56.23619460724202], [58.05341, 56.23792666049839], [58.053909999999995, 56.23965871375476], [58.05491, 56.23965871375476], [58.055409999999995, 56.23792666049839]]
,
[[58.055409999999995, 56.241390762113525], [58.05491, 56.23965870885716], [58.053909999999995, 56.23965870885716], [58.05341, 56.241390762113525], [58.053909999999995, 56.243122815369894], [58.05491, 56.243122815369894], [58.055409999999995, 56.241390762113525]]
,
[[58.055409999999995, 56.24485486372866], [58.05491, 56.24312281047229], [58.053909999999995, 56.24312281047229], [58.05341, 56.24485486372866], [58.053909999999995, 56.24658691698503], [58.05491, 56.24658691698503], [58.055409999999995, 56.24485486372866]]
,
[[58.053909999999995, 56.21194589838486], [58.05341, 56.21021384512849], [58.052409999999995, 56.21021384512849], [58.05191, 56.21194589838486], [58.052409999999995, 56.21367795164123], [58.05341, 56.21367795164123], [58.053909999999995, 56.21194589838486]]
,
[[58.053909999999995, 56.21541], [58.05341, 56.21367794674363], [58.052409999999995, 56.21367794674363], [58.05191, 56.21541], [58.052409999999995, 56.21714205325637], [58.05341, 56.21714205325637], [58.053909999999995, 56.21541]]
,
[[58.053909999999995, 56.218874101615135], [58.05341, 56.21714204835877], [58.052409999999995, 56.21714204835877], [58.05191, 56.218874101615135], [58.052409999999995, 56.220606154871504], [58.05341, 56.220606154871504], [58.053909999999995, 56.218874101615135]]
,
[[58.053909999999995, 56.22233820323027], [58.05341, 56.220606149973904], [58.052409999999995, 56.220606149973904], [58.05191, 56.22233820323027], [58.052409999999995, 56.22407025648664], [58.05341, 56.22407025648664], [58.053909999999995, 56.22233820323027]]
,
[[58.053909999999995, 56.22580230484541], [58.05341, 56.22407025158904], [58.052409999999995, 56.22407025158904], [58.05191, 56.22580230484541], [58.052409999999995, 56.22753435810178], [58.05341, 56.22753435810178], [58.053909999999995, 56.22580230484541]]
,
[[58.053909999999995, 56.229266406460546], [58.05341, 56.22753435320418], [58.052409999999995, 56.22753435320418], [58.05191, 56.229266406460546], [58.052409999999995, 56.230998459716915], [58.05341, 56.230998459716915], [58.053909999999995, 56.229266406460546]]
,
[[58.053909999999995, 56.23273050807568], [58.05341, 56.230998454819314], [58.052409999999995, 56.230998454819314], [58.05191, 56.23273050807568], [58.052409999999995, 56.23446256133205], [58.05341, 56.23446256133205], [58.053909999999995, 56.23273050807568]]
,
[[58.053909999999995, 56.23619460969082], [58.05341, 56.23446255643445], [58.052409999999995, 56.23446255643445], [58.05191, 56.23619460969082], [58.052409999999995, 56.23792666294719], [58.05341, 56.23792666294719], [58.053909999999995, 56.23619460969082]]
,
[[58.053909999999995, 56.23965871130596], [58.05341, 56.23792665804959], [58.052409999999995, 56.23792665804959], [58.05191, 56.23965871130596], [58.052409999999995, 56.241390764562325], [58.05341, 56.241390764562325], [58.053909999999995, 56.23965871130596]]
,
[[58.053909999999995, 56.243122812921094], [58.05341, 56.241390759664725], [58.052409999999995, 56.241390759664725], [58.05191, 56.243122812921094], [58.052409999999995, 56.24485486617746], [58.05341, 56.24485486617746], [58.053909999999995, 56.243122812921094]]
,
[[58.052409999999995, 56.21021384757729], [58.05191, 56.208481794320925], [58.050909999999995, 56.208481794320925], [58.05041, 56.21021384757729], [58.050909999999995, 56.21194590083366], [58.05191, 56.21194590083366], [58.052409999999995, 56.21021384757729]]
,
[[58.052409999999995, 56.21367794919243], [58.05191, 56.21194589593606], [58.050909999999995, 56.21194589593606], [58.05041, 56.21367794919243], [58.050909999999995, 56.2154100024488], [58.05191, 56.2154100024488], [58.052409999999995, 56.21367794919243]]
,
[[58.052409999999995, 56.21714205080757], [58.05191, 56.2154099975512], [58.050909999999995, 56.2154099975512], [58.05041, 56.21714205080757], [58.050909999999995, 56.218874104063936], [58.05191, 56.218874104063936], [58.052409999999995, 56.21714205080757]]
,
[[58.052409999999995, 56.220606152422704], [58.05191, 56.218874099166335], [58.050909999999995, 56.218874099166335], [58.05041, 56.220606152422704], [58.050909999999995, 56.22233820567907], [58.05191, 56.22233820567907], [58.052409999999995, 56.220606152422704]]
,
[[58.052409999999995, 56.22407025403784], [58.05191, 56.22233820078147], [58.050909999999995, 56.22233820078147], [58.05041, 56.22407025403784], [58.050909999999995, 56.22580230729421], [58.05191, 56.22580230729421], [58.052409999999995, 56.22407025403784]]
,
[[58.052409999999995, 56.22753435565298], [58.05191, 56.22580230239661], [58.050909999999995, 56.22580230239661], [58.05041, 56.22753435565298], [58.050909999999995, 56.229266408909346], [58.05191, 56.229266408909346], [58.052409999999995, 56.22753435565298]]
,
[[58.052409999999995, 56.230998457268115], [58.05191, 56.229266404011746], [58.050909999999995, 56.229266404011746], [58.05041, 56.230998457268115], [58.050909999999995, 56.23273051052448], [58.05191, 56.23273051052448], [58.052409999999995, 56.230998457268115]]
,
[[58.052409999999995, 56.23446255888325], [58.05191, 56.23273050562688], [58.050909999999995, 56.23273050562688], [58.05041, 56.23446255888325], [58.050909999999995, 56.23619461213962], [58.05191, 56.23619461213962], [58.052409999999995, 56.23446255888325]]
,
[[58.052409999999995, 56.23792666049839], [58.05191, 56.23619460724202], [58.050909999999995, 56.23619460724202], [58.05041, 56.23792666049839], [58.050909999999995, 56.23965871375476], [58.05191, 56.23965871375476], [58.052409999999995, 56.23792666049839]]
,
[[58.052409999999995, 56.241390762113525], [58.05191, 56.23965870885716], [58.050909999999995, 56.23965870885716], [58.05041, 56.241390762113525], [58.050909999999995, 56.243122815369894], [58.05191, 56.243122815369894], [58.052409999999995, 56.241390762113525]]
,
[[58.050909999999995, 56.208481796769725], [58.05041, 56.206749743513356], [58.049409999999995, 56.206749743513356], [58.04891, 56.208481796769725], [58.049409999999995, 56.21021385002609], [58.05041, 56.21021385002609], [58.050909999999995, 56.208481796769725]]
,
[[58.050909999999995, 56.21194589838486], [58.05041, 56.21021384512849], [58.049409999999995, 56.21021384512849], [58.04891, 56.21194589838486], [58.049409999999995, 56.21367795164123], [58.05041, 56.21367795164123], [58.050909999999995, 56.21194589838486]]
,
[[58.050909999999995, 56.21541], [58.05041, 56.21367794674363], [58.049409999999995, 56.21367794674363], [58.04891, 56.21541], [58.049409999999995, 56.21714205325637], [58.05041, 56.21714205325637], [58.050909999999995, 56.21541]]
,
[[58.050909999999995, 56.218874101615135], [58.05041, 56.21714204835877], [58.049409999999995, 56.21714204835877], [58.04891, 56.218874101615135], [58.049409999999995, 56.220606154871504], [58.05041, 56.220606154871504], [58.050909999999995, 56.218874101615135]]
,
[[58.050909999999995, 56.22233820323027], [58.05041, 56.220606149973904], [58.049409999999995, 56.220606149973904], [58.04891, 56.22233820323027], [58.049409999999995, 56.22407025648664], [58.05041, 56.22407025648664], [58.050909999999995, 56.22233820323027]]
,
[[58.050909999999995, 56.22580230484541], [58.05041, 56.22407025158904], [58.049409999999995, 56.22407025158904], [58.04891, 56.22580230484541], [58.049409999999995, 56.22753435810178], [58.05041, 56.22753435810178], [58.050909999999995, 56.22580230484541]]
,
[[58.050909999999995, 56.229266406460546], [58.05041, 56.22753435320418], [58.049409999999995, 56.22753435320418], [58.04891, 56.229266406460546], [58.049409999999995, 56.230998459716915], [58.05041, 56.230998459716915], [58.050909999999995, 56.229266406460546]]
,
[[58.050909999999995, 56.23273050807568], [58.05041, 56.230998454819314], [58.049409999999995, 56.230998454819314], [58.04891, 56.23273050807568], [58.049409999999995, 56.23446256133205], [58.05041, 56.23446256133205], [58.050909999999995, 56.23273050807568]]
,
[[58.050909999999995, 56.23619460969082], [58.05041, 56.23446255643445], [58.049409999999995, 56.23446255643445], [58.04891, 56.23619460969082], [58.049409999999995, 56.23792666294719], [58.05041, 56.23792666294719], [58.050909999999995, 56.23619460969082]]
,
[[58.050909999999995, 56.23965871130596], [58.05041, 56.23792665804959], [58.049409999999995, 56.23792665804959], [58.04891, 56.23965871130596], [58.049409999999995, 56.241390764562325], [58.05041, 56.241390764562325], [58.050909999999995, 56.23965871130596]]
,
[[58.049409999999995, 56.206749745962156], [58.04891, 56.20501769270579], [58.047909999999995, 56.20501769270579], [58.04741, 56.206749745962156], [58.047909999999995, 56.208481799218525], [58.04891, 56.208481799218525], [58.049409999999995, 56.206749745962156]]
,
[[58.049409999999995, 56.21021384757729], [58.04891, 56.208481794320925], [58.047909999999995, 56.208481794320925], [58.04741, 56.21021384757729], [58.047909999999995, 56.21194590083366], [58.04891, 56.21194590083366], [58.049409999999995, 56.21021384757729]]
,
[[58.049409999999995, 56.21367794919243], [58.04891, 56.21194589593606], [58.047909999999995, 56.21194589593606], [58.04741, 56.21367794919243], [58.047909999999995, 56.2154100024488], [58.04891, 56.2154100024488], [58.049409999999995, 56.21367794919243]]
,
[[58.049409999999995, 56.21714205080757], [58.04891, 56.2154099975512], [58.047909999999995, 56.2154099975512], [58.04741, 56.21714205080757], [58.047909999999995, 56.218874104063936], [58.04891, 56.218874104063936], [58.049409999999995, 56.21714205080757]]
,
[[58.049409999999995, 56.220606152422704], [58.04891, 56.218874099166335], [58.047909999999995, 56.218874099166335], [58.04741, 56.220606152422704], [58.047909999999995, 56.22233820567907], [58.04891, 56.22233820567907], [58.049409999999995, 56.220606152422704]]
,
[[58.049409999999995, 56.22407025403784], [58.04891, 56.22233820078147], [58.047909999999995, 56.22233820078147], [58.04741, 56.22407025403784], [58.047909999999995, 56.22580230729421], [58.04891, 56.22580230729421], [58.049409999999995, 56.22407025403784]]
,
[[58.049409999999995, 56.22753435565298], [58.04891, 56.22580230239661], [58.047909999999995, 56.22580230239661], [58.04741, 56.22753435565298], [58.047909999999995, 56.229266408909346], [58.04891, 56.229266408909346], [58.049409999999995, 56.22753435565298]]
,
[[58.049409999999995, 56.230998457268115], [58.04891, 56.229266404011746], [58.047909999999995, 56.229266404011746], [58.04741, 56.230998457268115], [58.047909999999995, 56.23273051052448], [58.04891, 56.23273051052448], [58.049409999999995, 56.230998457268115]]
,
[[58.049409999999995, 56.23446255888325], [58.04891, 56.23273050562688], [58.047909999999995, 56.23273050562688], [58.04741, 56.23446255888325], [58.047909999999995, 56.23619461213962], [58.04891, 56.23619461213962], [58.049409999999995, 56.23446255888325]]
,
[[58.049409999999995, 56.23792666049839], [58.04891, 56.23619460724202], [58.047909999999995, 56.23619460724202], [58.04741, 56.23792666049839], [58.047909999999995, 56.23965871375476], [58.04891, 56.23965871375476], [58.049409999999995, 56.23792666049839]]
,
[[58.047909999999995, 56.20501769515459], [58.04741, 56.20328564189822], [58.046409999999995, 56.20328564189822], [58.04591, 56.20501769515459], [58.046409999999995, 56.20674974841096], [58.04741, 56.20674974841096], [58.047909999999995, 56.20501769515459]]
,
[[58.047909999999995, 56.208481796769725], [58.04741, 56.206749743513356], [58.046409999999995, 56.206749743513356], [58.04591, 56.208481796769725], [58.046409999999995, 56.21021385002609], [58.04741, 56.21021385002609], [58.047909999999995, 56.208481796769725]]
,
[[58.047909999999995, 56.21194589838486], [58.04741, 56.21021384512849], [58.046409999999995, 56.21021384512849], [58.04591, 56.21194589838486], [58.046409999999995, 56.21367795164123], [58.04741, 56.21367795164123], [58.047909999999995, 56.21194589838486]]
,
[[58.047909999999995, 56.21541], [58.04741, 56.21367794674363], [58.046409999999995, 56.21367794674363], [58.04591, 56.21541], [58.046409999999995, 56.21714205325637], [58.04741, 56.21714205325637], [58.047909999999995, 56.21541]]
,
[[58.047909999999995, 56.218874101615135], [58.04741, 56.21714204835877], [58.046409999999995, 56.21714204835877], [58.04591, 56.218874101615135], [58.046409999999995, 56.220606154871504], [58.04741, 56.220606154871504], [58.047909999999995, 56.218874101615135]]
,
[[58.047909999999995, 56.22233820323027], [58.04741, 56.220606149973904], [58.046409999999995, 56.220606149973904], [58.04591, 56.22233820323027], [58.046409999999995, 56.22407025648664], [58.04741, 56.22407025648664], [58.047909999999995, 56.22233820323027]]
,
[[58.047909999999995, 56.22580230484541], [58.04741, 56.22407025158904], [58.046409999999995, 56.22407025158904], [58.04591, 56.22580230484541], [58.046409999999995, 56.22753435810178], [58.04741, 56.22753435810178], [58.047909999999995, 56.22580230484541]]
,
[[58.047909999999995, 56.229266406460546], [58.04741, 56.22753435320418], [58.046409999999995, 56.22753435320418], [58.04591, 56.229266406460546], [58.046409999999995, 56.230998459716915], [58.04741, 56.230998459716915], [58.047909999999995, 56.229266406460546]]
,
[[58.047909999999995, 56.23273050807568], [58.04741, 56.230998454819314], [58.046409999999995, 56.230998454819314], [58.04591, 56.23273050807568], [58.046409999999995, 56.23446256133205], [58.04741, 56.23446256133205], [58.047909999999995, 56.23273050807568]]
,
[[58.047909999999995, 56.23619460969082], [58.04741, 56.23446255643445], [58.046409999999995, 56.23446255643445], [58.04591, 56.23619460969082], [58.046409999999995, 56.23792666294719], [58.04741, 56.23792666294719], [58.047909999999995, 56.23619460969082]]
,
[[58.046409999999995, 56.20328564434702], [58.04591, 56.20155359109065], [58.044909999999994, 56.20155359109065], [58.04441, 56.20328564434702], [58.044909999999994, 56.20501769760339], [58.04591, 56.20501769760339], [58.046409999999995, 56.20328564434702]]
,
[[58.046409999999995, 56.206749745962156], [58.04591, 56.20501769270579], [58.044909999999994, 56.20501769270579], [58.04441, 56.206749745962156], [58.044909999999994, 56.208481799218525], [58.04591, 56.208481799218525], [58.046409999999995, 56.206749745962156]]
,
[[58.046409999999995, 56.21021384757729], [58.04591, 56.208481794320925], [58.044909999999994, 56.208481794320925], [58.04441, 56.21021384757729], [58.044909999999994, 56.21194590083366], [58.04591, 56.21194590083366], [58.046409999999995, 56.21021384757729]]
,
[[58.046409999999995, 56.21367794919243], [58.04591, 56.21194589593606], [58.044909999999994, 56.21194589593606], [58.04441, 56.21367794919243], [58.044909999999994, 56.2154100024488], [58.04591, 56.2154100024488], [58.046409999999995, 56.21367794919243]]
,
[[58.046409999999995, 56.21714205080757], [58.04591, 56.2154099975512], [58.044909999999994, 56.2154099975512], [58.04441, 56.21714205080757], [58.044909999999994, 56.218874104063936], [58.04591, 56.218874104063936], [58.046409999999995, 56.21714205080757]]
,
[[58.046409999999995, 56.220606152422704], [58.04591, 56.218874099166335], [58.044909999999994, 56.218874099166335], [58.04441, 56.220606152422704], [58.044909999999994, 56.22233820567907], [58.04591, 56.22233820567907], [58.046409999999995, 56.220606152422704]]
,
[[58.046409999999995, 56.22407025403784], [58.04591, 56.22233820078147], [58.044909999999994, 56.22233820078147], [58.04441, 56.22407025403784], [58.044909999999994, 56.22580230729421], [58.04591, 56.22580230729421], [58.046409999999995, 56.22407025403784]]
,
[[58.046409999999995, 56.22753435565298], [58.04591, 56.22580230239661], [58.044909999999994, 56.22580230239661], [58.04441, 56.22753435565298], [58.044909999999994, 56.229266408909346], [58.04591, 56.229266408909346], [58.046409999999995, 56.22753435565298]]
,
[[58.046409999999995, 56.230998457268115], [58.04591, 56.229266404011746], [58.044909999999994, 56.229266404011746], [58.04441, 56.230998457268115], [58.044909999999994, 56.23273051052448], [58.04591, 56.23273051052448], [58.046409999999995, 56.230998457268115]]
,
[[58.046409999999995, 56.23446255888325], [58.04591, 56.23273050562688], [58.044909999999994, 56.23273050562688], [58.04441, 56.23446255888325], [58.044909999999994, 56.23619461213962], [58.04591, 56.23619461213962], [58.046409999999995, 56.23446255888325]]
,
[[58.044909999999994, 56.20155359353945], [58.04441, 56.19982154028308], [58.043409999999994, 56.19982154028308], [58.04291, 56.20155359353945], [58.043409999999994, 56.20328564679582], [58.04441, 56.20328564679582], [58.044909999999994, 56.20155359353945]]
,
[[58.044909999999994, 56.20501769515459], [58.04441, 56.20328564189822], [58.043409999999994, 56.20328564189822], [58.04291, 56.20501769515459], [58.043409999999994, 56.20674974841096], [58.04441, 56.20674974841096], [58.044909999999994, 56.20501769515459]]
,
[[58.044909999999994, 56.208481796769725], [58.04441, 56.206749743513356], [58.043409999999994, 56.206749743513356], [58.04291, 56.208481796769725], [58.043409999999994, 56.21021385002609], [58.04441, 56.21021385002609], [58.044909999999994, 56.208481796769725]]
,
[[58.044909999999994, 56.21194589838486], [58.04441, 56.21021384512849], [58.043409999999994, 56.21021384512849], [58.04291, 56.21194589838486], [58.043409999999994, 56.21367795164123], [58.04441, 56.21367795164123], [58.044909999999994, 56.21194589838486]]
,
[[58.044909999999994, 56.21541], [58.04441, 56.21367794674363], [58.043409999999994, 56.21367794674363], [58.04291, 56.21541], [58.043409999999994, 56.21714205325637], [58.04441, 56.21714205325637], [58.044909999999994, 56.21541]]
,
[[58.044909999999994, 56.218874101615135], [58.04441, 56.21714204835877], [58.043409999999994, 56.21714204835877], [58.04291, 56.218874101615135], [58.043409999999994, 56.220606154871504], [58.04441, 56.220606154871504], [58.044909999999994, 56.218874101615135]]
,
[[58.044909999999994, 56.22233820323027], [58.04441, 56.220606149973904], [58.043409999999994, 56.220606149973904], [58.04291, 56.22233820323027], [58.043409999999994, 56.22407025648664], [58.04441, 56.22407025648664], [58.044909999999994, 56.22233820323027]]
,
[[58.044909999999994, 56.22580230484541], [58.04441, 56.22407025158904], [58.043409999999994, 56.22407025158904], [58.04291, 56.22580230484541], [58.043409999999994, 56.22753435810178], [58.04441, 56.22753435810178], [58.044909999999994, 56.22580230484541]]
,
[[58.044909999999994, 56.229266406460546], [58.04441, 56.22753435320418], [58.043409999999994, 56.22753435320418], [58.04291, 56.229266406460546], [58.043409999999994, 56.230998459716915], [58.04441, 56.230998459716915], [58.044909999999994, 56.229266406460546]]
,
[[58.044909999999994, 56.23273050807568], [58.04441, 56.230998454819314], [58.043409999999994, 56.230998454819314], [58.04291, 56.23273050807568], [58.043409999999994, 56.23446256133205], [58.04441, 56.23446256133205], [58.044909999999994, 56.23273050807568]]
,
[[58.043409999999994, 56.19982154273188], [58.04291, 56.198089489475514], [58.041909999999994, 56.198089489475514], [58.04141, 56.19982154273188], [58.041909999999994, 56.20155359598825], [58.04291, 56.20155359598825], [58.043409999999994, 56.19982154273188]]
,
[[58.043409999999994, 56.20328564434702], [58.04291, 56.20155359109065], [58.041909999999994, 56.20155359109065], [58.04141, 56.20328564434702], [58.041909999999994, 56.20501769760339], [58.04291, 56.20501769760339], [58.043409999999994, 56.20328564434702]]
,
[[58.043409999999994, 56.206749745962156], [58.04291, 56.20501769270579], [58.041909999999994, 56.20501769270579], [58.04141, 56.206749745962156], [58.041909999999994, 56.208481799218525], [58.04291, 56.208481799218525], [58.043409999999994, 56.206749745962156]]
,
[[58.043409999999994, 56.21021384757729], [58.04291, 56.208481794320925], [58.041909999999994, 56.208481794320925], [58.04141, 56.21021384757729], [58.041909999999994, 56.21194590083366], [58.04291, 56.21194590083366], [58.043409999999994, 56.21021384757729]]
,
[[58.043409999999994, 56.21367794919243], [58.04291, 56.21194589593606], [58.041909999999994, 56.21194589593606], [58.04141, 56.21367794919243], [58.041909999999994, 56.2154100024488], [58.04291, 56.2154100024488], [58.043409999999994, 56.21367794919243]]
,
[[58.043409999999994, 56.21714205080757], [58.04291, 56.2154099975512], [58.041909999999994, 56.2154099975512], [58.04141, 56.21714205080757], [58.041909999999994, 56.218874104063936], [58.04291, 56.218874104063936], [58.043409999999994, 56.21714205080757]]
,
[[58.043409999999994, 56.220606152422704], [58.04291, 56.218874099166335], [58.041909999999994, 56.218874099166335], [58.04141, 56.220606152422704], [58.041909999999994, 56.22233820567907], [58.04291, 56.22233820567907], [58.043409999999994, 56.220606152422704]]
,
[[58.043409999999994, 56.22407025403784], [58.04291, 56.22233820078147], [58.041909999999994, 56.22233820078147], [58.04141, 56.22407025403784], [58.041909999999994, 56.22580230729421], [58.04291, 56.22580230729421], [58.043409999999994, 56.22407025403784]]
,
[[58.043409999999994, 56.22753435565298], [58.04291, 56.22580230239661], [58.041909999999994, 56.22580230239661], [58.04141, 56.22753435565298], [58.041909999999994, 56.229266408909346], [58.04291, 56.229266408909346], [58.043409999999994, 56.22753435565298]]
,
[[58.043409999999994, 56.230998457268115], [58.04291, 56.229266404011746], [58.041909999999994, 56.229266404011746], [58.04141, 56.230998457268115], [58.041909999999994, 56.23273051052448], [58.04291, 56.23273051052448], [58.043409999999994, 56.230998457268115]]

];
L.polygon(CorPol).addTo(map);

/*var PolygonData = {"type":"FeatureCollection","features":[
{"type":"Feature","id":"01","properties":{"name":"Alabama","density":94.65},"geometry":{"type":"Polygon","coordinates":[[  [58.05465, 56.21698],[58.05408, 56.21618], [58.05373, 56.21683], [58.0537, 56.21764], [58.05423, 56.21822], [58.05465, 56.21698]   ]]}},
{"type":"Feature","id":"02","properties":{"name":"Alaska","density":1.264},"geometry":{"type":"MultiPolygon","coordinates":[[[   [58.05465, 56.21698],[58.05408, 56.21618], [58.05373, 56.21683], [58.0537, 56.21764], [58.05423, 56.21822], [58.05465, 56.21698]  ]]]}}
]};
L.geoJson(PolygonData).addTo(map);
console.log(PolygonData);
*/

function get_loc() {
    xmlhttp = new XMLHttpRequest();
    try
    {
        xmlhttp.open("GET", "/GIS/get/current_loc");
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState == 4)
            {
                if (xmlhttp.status == 200)
                {
                    console.log("xmlhttp.readyState == 4");
                    //var marker = L.marker([lat,lng]).addTo(map);
                    //console.log(xmlhttp.responseText)
                    geojsonFeature = JSON.parse(xmlhttp.responseText);
                    //console.log(geojsonFeature)
                    //L.marker([51.5, -0.09]).addTo(map)

                    //x = L.geoJson(geojsonFeature).addTo(map);
                    //console.log(geojsonFeature.geometry.coordinates[0], geojsonFeature.geometry.coordinates[1]);
                    //console.log(geojsonFeature['coordinates'][0]);
                    //marker.setLatLng(L.geoJson(geojsonFeature));
                    cur_loc = new L.LatLng(geojsonFeature.geometry.coordinates[1], geojsonFeature.geometry.coordinates[0]);
                    //console.log(cur_loc)

                    marker.setLatLng(cur_loc);
                }
                else
                {
                    //delete marker
                }
            }
        }

        xmlhttp.send(null);
    }
    catch (e)
    {
        //delete marker
    }
}

function get_way()
{
    xmlhttp = new XMLHttpRequest();
    try
    {
        xmlhttp.open("GET", "/GIS/get/way");
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState == 4)
            {
                if (xmlhttp.status == 200)
                {
                    myLines = JSON.parse(xmlhttp.responseText);
                    //L.geoJson(myLines, {
                    //	style: myStyle
                    //}).addTo(map);

                    ///set line
                    //console.log(myLines.geometry.coordinates)
                    var Arr1 = myLines.geometry.coordinates

                    var LtLnArray = new Array(Arr1.length);
                    var index = 0;
                    //console.log(myLines)
                    while(index < LtLnArray.length){
                        LtLnArray[index] = new L.latLng(myLines.geometry.coordinates[index][1], myLines.geometry.coordinates[index][0]);
                        //console.log(LtLnArray[index])
                        index++;
                    }
                    //console.log(LtLnArray);
                    //latlng_way = new L.latLng(myLines.geometry.coordinates);
                    //console.log(latlng_way)
                    //console.log('DO')
                    //console.log(line_way);
                    line_way = line_way.setLatLngs(LtLnArray);
                    //console.log('POSLE')
                    //console.log(line_way);
                }

                else
                {
                    //delete marker
                }
            }
        }
        xmlhttp.send(null);
    }

    catch (e)
    {
        //delete marker
    }
}

var timer_loc = window.setInterval("get_loc();", 3000);
var timer_way = window.setInterval("get_way();", 5000);

function cust_way(){
    if(flag == 1){
        get_loc();
        custom_way.addLatLng(marker.getLatLng());
        //custom_way.setLatLngs(marker.getLatLng());
        console.log(flag)
        flag = 0
        console.log(flag)
    }
}

function onMapClick(e) {
    popup
        .setLatLng(e.latlng)
        .setContent("New way point " + e.latlng.toString())
        .openOn(map);
        console.log(e);
    cust_way();
    custom_way.addLatLng(e.latlng);
}



map.on('click', onMapClick);